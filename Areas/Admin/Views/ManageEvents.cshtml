@model List<EventOrganizer_ASP.NET.Areas.Admin.ViewModels.AdminEventVM>
@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="d-flex justify-content-between mb-3">
    <h3>Manage Events</h3>
    <a href="/Admin/Event/Add" class="btn btn-dark">Add New Event</a>
</div>

<div class="card p-3 shadow">
    <table class="table">
        <thead>
            <tr>
                <th>Event Name</th>
                <th>Category</th>
                <th>Date</th>
                <th>Status</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model)
            {
                <tr>
                    <td>@item.Title</td>
                    <td>@item.CategoryName</td>
                    <td>@item.EventDate.ToString("MMM dd, yyyy")</td>
                    <td>
                        @if (item.Status == "Active")
                        {
                            <span class="text-success fw-semibold">Active</span>
                        }
                        else
                        {
                            <span class="text-danger fw-semibold">Completed</span>
                        }
                    </td>
                    <td>
                        <button class="btn btn-warning btn-sm me-1"
                                onclick="openEditModal(
                                        @item.EventId,
                                        '@Html.Raw(item.Title.Replace("'", "\\'"))',
                                        '@item.EventDate.ToString("yyyy-MM-dd")',
                                        '@item.EventTime',
                                        '@Html.Raw(item.Location.Replace("'", "\\'"))',
                                        '@Html.Raw(item.Description?.Replace("'", "\\'"))',
                                        @item.CategoryId)">
                            Edit
                        </button>
                        <a href="/Admin/Event/Delete/@item.EventId"
                           class="btn btn-danger btn-sm"
                           onclick="return confirm('Delete this event?')">
                            Delete
                        </a>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editEventModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 rounded-3">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="editModalLabel">Edit Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form method="post" action="/Admin/Event/Edit">
                    <input type="hidden" name="EventId" id="edit_EventId" />
                    <div class="row g-3">

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Event Name</label>
                            <input type="text" name="Title" id="edit_Title"
                                   class="form-control bg-light border-0" required />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Category Tag</label>
                            <select name="CategoryId" id="edit_CategoryId"
                                    class="form-select bg-light border-0" required>
                                <option value="" disabled>-- Select Category --</option>
                                @foreach (var cat in ViewBag.Categories as List<EventOrganizer_ASP.NET.Areas.Admin.ViewModels.CategoryVM>)
                                {
                                    <option value="@cat.CategoryId">@cat.CategoryName</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Event Date</label>
                            <input type="date" name="EventDate" id="edit_EventDate"
                                   class="form-control bg-light border-0" required />
                        </div>

                        <div class="col-md-6">
                            <label class="form-label fw-semibold">Event Time</label>
                            <input type="time" name="EventTime" id="edit_EventTime"
                                   class="form-control bg-light border-0" required />
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-semibold">Venue / Location</label>
                            <input type="text" name="Location" id="edit_Location"
                                   class="form-control bg-light border-0" required />
                        </div>

                        <div class="col-md-12">
                            <label class="form-label fw-semibold">Short Description (For card)</label>
                            <textarea name="Description" id="edit_Description"
                                      class="form-control bg-light border-0" rows="3"></textarea>
                        </div>

                    </div>
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn text-white fw-semibold px-4"
                                style="background-color: #e8450a;">
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function openEditModal(id, title, date, time, location, description, categoryId) {
            document.getElementById('edit_EventId').value = id;
            document.getElementById('edit_Title').value = title;
            document.getElementById('edit_EventDate').value = date;
            document.getElementById('edit_EventTime').value = time ? time.substring(0, 5) : '';
            document.getElementById('edit_Location').value = location;
            document.getElementById('edit_Description').value = description ?? '';

            // Set correct category in dropdown
            var select = document.getElementById('edit_CategoryId');
            for (var i = 0; i < select.options.length; i++) {
                select.options[i].selected = (select.options[i].value == categoryId);
            }

            var modal = new bootstrap.Modal(document.getElementById('editEventModal'));
            modal.show();
        }
    </script>
}